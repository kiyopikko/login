<!DOCTYPE html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>memo</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
        <!-- Latest compiled and minified CSS -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">
        <!-- Optional theme -->
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap-theme.min.css">
        <!-- Latest compiled and minified JavaScript -->
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
            <script src="http://127.0.0.1:3000/js/milkcocoa.js"></script>
            <script>
        	function escapeHTML(val) {
                return $('<div>').text(val).html();
            };
            	function refresh_html(id, args) {
            		$("#content").html($("#" + id).html());
            		if(id == "signin-html") {
                    	$("#signin").click(function() {
                    		var email = $('#signin-form [name=email]').val()
                    		var password = $('#signin-form [name=password]').val()
                        	milkcocoa.Account.signIn(email, password, function(err, user) {
                        		console.log(user);
                        		if(user) {
                            		var ds = new milkcocoa.DataStore("memo." + user.id);
                        			refresh_html("memo-html", {userDataStore : ds});
                        		}else{
                            		alert("signin failed.");
                        		}
                        	});
                     		return false;
                    	});
                    	$("#signup").click(function() {
                    		var email = $('#signup-form [name=email]').val()
                    		var password = $('#signup-form [name=password]').val()
                    		var confirm = $('#signup-form [name=confirm]').val()
                    		if(password != confirm) {
                    			return false;
                    		}
                        	milkcocoa.Account.signUp(email, password, {}, function(err, user) {
                        		if(user) {
                            		alert("signup success!!");
                        		}else{
                            		alert("signup failed!!");
                        		}
                        	});
                     		return false;
                    	});
            		}else if(id == "signup-html") {
            		}else if(id == "memo-html") {
                        var ds = args.userDataStore;
                        ds.findMany({}).done(function(e) {
                            for(var i=0;i < e.length;i++) {
                                $("#messages").append('<div id="'+e[i].id+'">' + escapeHTML(e[i].content) + "</div>");
                            }
                        });
                        ds.on("push", function(e) {
                            $("#messages").append(escapeHTML(e.content) + "<br>");
                        });
                        $("#post").click(function() {
                            ds.push({
                                title : "タイトル",
                                content : $("#message-content").val()
                            }, function(e) {
                                $("#message-content").val("");
                            });
                        });
            		}
            	}
                pour_the_milk("127.0.0.1:3000", "loginapp", function() {
                	milkcocoa.Account.getCurrentUser( function(err, user) {
                		console.log(user);
                		if(user) {
                    		var ds = new milkcocoa.DataStore("memo." + user.id);
                			refresh_html("memo-html", {userDataStore : ds});
                		}else{
                			refresh_html("signin-html")
                		}
                	});
                })
                
                </script>
    </head>
    <body>
    	<script id="signup-html" type="text/html">
    	<form id="signup-form">
    	<input type="text" name="email" />
    	<input type="password" name="password" />
        <button id="signup">SignUp</button>
        </form>
		</div>
		</script>
    	<script id="signin-html" type="text/html">
		<div>
    	<form id="signin-form" class="form-signin" role="form">
		<h2 class="form-signin-heading">Please sign in</h2>
        <input type="email" name="email" class="form-control" placeholder="Email address" required autofocus>
        <input type="password" name="password" class="form-control" placeholder="Password" required>
        <button id="signin" class="btn btn-lg btn-primary btn-block" type="submit">SignIn</button>
        </form>
		</div>
		<div>
    	<form id="signup-form" class="form-signin" role="form">
		<h2 class="form-signin-heading">Please sign up</h2>
        <input type="email" name="email" class="form-control" placeholder="Email address" required autofocus>
        <input type="password" name="password" class="form-control" placeholder="Password" required>
        <input type="password" name="confirm" class="form-control" placeholder="Confirm" required>
        <button id="signup" class="btn btn-lg btn-primary btn-block" type="submit">SignUp</button>
        </form>
		</div>
		</script>
    	<script id="memo-html" type="text/html">
		<div class="panel panel-primary">
			<div class="panel-heading">
				<h3 class="panel-title">Your Memo</h3>
			</div>
			<div class="panel-body">
				<textarea id="message-content" cols="32" rows="4"></textarea>
		        <button id="post" class="btn btn-primary">add memo</button>
        		<div id="messages"></div>
			</div>
		</div>
		</script>
		<div id="content" class="container"></div> <!-- /container -->
    </body>
</html>
